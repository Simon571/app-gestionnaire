<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Démarrage…</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at top, #1d4ed8 0%, #0f172a 55%, #020617 100%);
        font-family: "PT Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #e2e8f0;
      }
      h1 {
        font-size: 1.25rem;
        letter-spacing: 0.04em;
        margin-top: 1.25rem;
      }
      p {
        margin: 0.5rem 0 0;
        font-size: 0.95rem;
        color: rgba(226, 232, 240, 0.85);
      }
      .spinner {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        border: 5px solid rgba(148, 163, 184, 0.25);
        border-top-color: #38bdf8;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .status {
        margin-top: 1.5rem;
        font-size: 0.85rem;
        opacity: 0.75;
      }
      button {
        margin-top: 1.75rem;
        padding: 0.55rem 1.5rem;
        border-radius: 9999px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: transparent;
        color: inherit;
        font-size: 0.85rem;
        cursor: pointer;
        transition: border-color 0.2s ease, color 0.2s ease;
      }
      button:hover {
        border-color: rgba(129, 140, 248, 0.7);
        color: #93c5fd;
      }
    </style>
  </head>
  <body>
    <div class="spinner" role="presentation" aria-hidden="true"></div>
    <h1>Démarrage de l'application…</h1>
    <p class="status" id="status">Initialisation du serveur interne</p>
    <button type="button" id="retry" hidden>Réessayer</button>
    <script>
      const TARGET_URL = 'http://127.0.0.1:1420';
      const RETRY_LABEL = 'Réessayer';
      const statusEl = document.getElementById('status');
      const retryButton = document.getElementById('retry');

      const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

      async function waitForServer(timeoutMs) {
        const deadline = Date.now() + timeoutMs;
        let attempt = 0;
        while (Date.now() < deadline) {
          attempt += 1;
          statusEl.textContent = `Connexion au serveur interne (tentative ${attempt})`;
          try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 3500);
            await fetch(TARGET_URL, {
              method: 'GET',
              mode: 'no-cors',
              cache: 'no-store',
              signal: controller.signal,
            });
            clearTimeout(timeout);
            return true;
          } catch (err) {
            await sleep(500);
          }
        }
        return false;
      }

      async function bootstrap() {
        retryButton.hidden = true;
        statusEl.textContent = 'Initialisation du serveur interne';
        const ready = await waitForServer(60000);
        if (ready) {
          statusEl.textContent = 'Serveur prêt, ouverture de l\'interface';
          window.location.replace(TARGET_URL);
        } else {
          statusEl.textContent = 'Impossible de démarrer le serveur interne. Vérifiez que Node.js est disponible et réessayez.';
          retryButton.textContent = RETRY_LABEL;
          retryButton.hidden = false;
        }
      }

      retryButton.addEventListener('click', () => {
        statusEl.textContent = 'Nouvelle tentative…';
        bootstrap();
      });

      bootstrap();
    </script>
  </body>
</html>
